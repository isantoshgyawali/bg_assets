name: Sync Images from Google Drive

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y rclone webp libheif-examples libheif1 file jq

      - name: Configure rclone
        run: |
          echo "${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}" | base64 -d > gdrive.json
          rclone config create gdrive drive \
            scope drive.readonly \
            service_account_file gdrive.json \
            shared_with_me true

      - name: Pull images from Google Drive
        run: |
          rm -rf raw-images
          mkdir -p raw-images

          declare -A dirs=(
            ["event"]="001"
            ["street"]="002"
            ["travel_and_landscape"]="003"
            ["commercial"]="004"
            ["portrait_and_lifestyle"]="005"
          )

          for drive_dir in "${!dirs[@]}"; do
            local_dir="raw-images/${dirs[$drive_dir]}"
            mkdir -p "$local_dir"
            rclone sync "gdrive:portfolio/$drive_dir" "$local_dir" \
              --drive-shared-with-me \
              --update \
              --delete-during \
              -vP
          done

      - name: Clean converted directories
        run: |
          rm -rf 001 002 003 004 005
          mkdir -p 001 002 003 004 005

      - name: Convert images to WebP
        run: |
          find raw-images -type f -print0 | while IFS= read -r -d '' img; do
            mime=$(file --mime-type -b "$img")
            [[ "$mime" != image/* ]] && continue

            rel="${img#raw-images/}"
            target_dir="${rel%%/*}"
            base="$(basename "$img")"
            name="${base%.*}"
            out="${target_dir}/${name}.webp"

            mkdir -p "$(dirname "$out")"
            echo "Converting: $img â†’ $out"

            if [[ "$mime" == "image/heic" ]]; then
              tmp="/tmp/${name}.jpg"
              heif-convert "$img" "$tmp"
              cwebp "$tmp" -q 85 -resize 1200 0 -o "$out"
              rm "$tmp"
            else
              cwebp "$img" -q 85 -resize 1200 0 -o "$out"
            fi
          done

      - name: Generate gallery.json files
        run: |
          for dir in 001 002 003 004 005; do
            if find "$dir" -maxdepth 1 -name "*.webp" | grep -q .; then
              find "$dir" -maxdepth 1 -type f -name "*.webp" -print0 \
                | xargs -0 -n 1 basename \
                | jq -R . \
                | jq -s '{ images: . }' \
                > "$dir/gallery.json"

              echo "Generated $dir/gallery.json"
            fi
          done

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add 001 002 003 004 005

          if ! git diff --cached --quiet; then
            git commit -m "sync: update images & gallery manifests from Drive [skip ci]"
            git push
          else
            echo "No changes detected. Skipping commit."
          fi
